---
title: "IPTW"
author: "David Cavallucci"
date: "7 May 2015"
output: html_document
---

#Load libraries
```{r,results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=TRUE}
library(gdata)
library(readxl)
library(readr)
library(ggplot2)
library(ggthemes)
library(survival)
library(lubridate)
library(mice)
source("stable.weights.R")
library(twang)
library(dplyr)
library(tidyr)
library(magrittr)
library(knitr)
library(stringr)
library(rlist)
library(grid)
library(scales)
```

#Import, clean-up
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=TRUE}
source("data_tidying.R")
rm(raw, dif_segs, id_twostage)
```


#Missing data patterns
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}

#Visualise missing data
library(mi)
subnew %>% dplyr::select(-primaryM) -> mi.data
mdf <- missing_data.frame(as.data.frame(mi.data))
image(mdf)
detach(package:mi)
```

#Imputation
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=TRUE}
library(mice)
#Do the imputations
imp <- mice(as.data.frame(subnew), method="cart", maxit=10)
```

```{r,  results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
imptmp <- complete(imp, "long", include=TRUE)
imptmp %<>% group_by(.imp, id_patients) %>% mutate(
    primaryT=first(primaryT),
    primaryN=first(primaryN),
    primarytumourgrade=first(primarytumourgrade),
    primarytreatment=first(primarytreatment))
imptmp %<>% ungroup() %>% mutate(posmarg = ifelse(margin<1,1,0))
imptmp$posmarg <- as.factor(imptmp$posmarg)
imptmp %>% group_by(id_patients) %>% mutate(cumlap = cumsum(lap)) %>% ungroup() -> imptmp
impmids <- as.mids(as.data.frame(imptmp))

```

#PS scores
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=TRUE}
propscores <- vector("list")
for(i in 1:5) {
      tmp <- ps(lap~age+sex+CEA+ismajor+difloc+isbilateral+lesionmaxdiameter+lesioncount+primarytumourgrade+primaryT+primaryN+year_primary+primarytreatment, estimand = "ATE", data=complete(impmids,i), interaction.depth=2, n.trees = 10000, shrinkage=0.01, verbose=FALSE, bag.fraction = 0.3, stop.method = "ks.max")
      propscores[[paste("psate",i,sep="")]] <- tmp
}

```


#Summarise
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
psresults <- vector("list")
impdata <- vector("list")
impweights <- vector("list")
impdata[["psate0"]] <- as.data.frame(subnew)
impdata[["psate0"]]$stable.w <- 1

  for (i in 1:5) {
      print(bal.table(propscores[[i]])$ks.max.ATE["ismajor",c("tx.mn", "ct.mn","std.eff.sz", "ks.pval","p")])
      name <- paste("psate",i,sep="")
      psresults[[name]] <- propscores[[i]]
      impdata[[name]] <- complete(impmids,i)
      impdata[[name]]$stable.w <- stable.weights(propscores[[i]], "ks.max")
      impweights[[name]] <- data.frame(weights=stable.weights(propscores[[i]], "ks.max"), treat=propscores[[i]]$treat, id=propscores[[i]]$data$id_patients)
}

```

#Plots and balance computations
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
#Make a dataframe from the imputed scores and average the weights
#ave.wt <- as_data_frame(list.map(impweights, weights)) %>% rowMeans()

#plotweights <- data.frame(weights=c(unlist(list.map(impweights, weights))), treat=c(unlist(list.map(impweights, treat))), imp=rep(1:5, each=284), id=c(unlist(list.map(impweights, id))))

#dx.names <- psresults[[1]]$gbm.obj$var.names
#dx.ave.wt <- dx.wts(ave.wt, data=impdata[[2]], vars=dx.names, estimand="ATE", treat.var = "lap")
#bal.dx.ave.wt <- bal.table(dx.ave.wt)
#bal.dx.ave.wt <-  list(unw=bal.dx.ave.wt$unw, wtd=bal.dx.ave.wt[[2]])


#Start building plots
#source("balance_plots.R")


#Boxplot of weights
#ggplot(plotweights, aes(factor(treat), weights, fill=interaction(factor(imp), factor(treat)))) + geom_boxplot() + facet_wrap(~imp)
#histogram of weights
#ggplot(plotweights, aes(weights, fill=interaction(as.factor(imp), as.factor(treat)))) + geom_histogram() + facet_wrap(~imp)

source("new_balance_plots.R")
```


#New Plot/balance output
```{r, results='asis', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
for (i in 1:5) {
  show(kable(cbind(round(ballist[[i]]$unw[,c("tx.mn", "ct.mn","std.eff.sz", "p")],2), round(ballist[[i]]$wtd[,c("tx.mn", "ct.mn","std.eff.sz", "p")],2)), align = 'l'))
}

for (i in 1:5) {show(balplotlist[[i]])}
for (i in 1:5) {show(qqplotlist[[i]])}

```


#Plot/balance output
```{r, results='asis', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
# knitr::kable(cbind(round(bal.dx.ave.wt$unw[,c("tx.mn", "ct.mn","std.eff.sz", "p")],2), round(bal.dx.ave.wt$wtd[,c("tx.mn", "ct.mn","std.eff.sz", "p")],2)))
# 
# balplot
# qqbalplot
```

#Make large dataframe
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
finaldata <- plyr::rbind.fill(impdata)
#Combine 2nd and greater number of ops due to small numbers
finaldata$index <- car::recode(finaldata$index, '2:4=2')
finaldata$.imp <- rep(0:5, each=284)
finaldata$.id <- rep(1:284, times=6)

finaldata <- finaldata %>% group_by(.imp, id_patients) %>% 
  mutate(ctime = ifelse(index<max(index),rtime,cens_time),
         numlap = sum(lap),
         cens_month = round(cens_time/365.25*12, digits = 1),
         gaptime = rtime-time)
finaldata$numlap <- car::Recode(finaldata$numlap, '2:4=2')
#finaldata$stable.w <- ave.wt
finaldata[finaldata$.imp==0,]$posmarg <- finaldata[finaldata$.imp==1,]$posmarg
finaldata %>% group_by(.imp) %>% mutate(mhlos = hlos - mean(hlos, na.rm=T)) -> finaldata

#Final imputed mids
imp.mids <- as.mids(as.data.frame(finaldata), .imp = match(".imp", names(finaldata)), .id=match(".id", names(finaldata)))
rm(impmids, impweights, imptmp)
```

#MItools version
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
#mitools version
library(mitools)
mit <- impdata[2:6]
for (i in 1:5) {
  #mit[[i]]$stable.w <- ave.wt
  mit[[i]]$index <- car::recode(mit[[i]]$index, '2:4=2')
  mit[[i]] %>% group_by(id_patients) %>%
    mutate(ctime = ifelse(index<max(index),rtime,cens_time),
    numlap = sum(lap),
    cens_month = round(cens_time/365.25*12, digits = 1),
    gaptime = rtime-time) -> mit[[i]]
  mit[[i]]$numlap <- car::Recode(mit[[i]]$numlap, '2:4=2')
  mit[[i]] %>% mutate(mhlos = hlos-mean(hlos, na.rm=T)) -> mit[[i]]
}

```

#Survey design parts
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=TRUE}
midata <- imputationList(mit)
design.ate <- svydesign(ids = ~id_patients, weights=~stable.w, data=midata)
design.sing <- svydesign(ids = ~id_patients, weights=~stable.w, data=midata$imputations$psate1)
design.unw <- svydesign(ids = ~id_patients, data=midata)
```


#Output
#Demographics
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
#Summarise distinct patient numbers and total procedure numbers by surgical approach
new %>% 
  group_by(lap) %>% 
  summarise(patients=n_distinct(id_patients), procedures=n()) -> ptnumbers

#Single ops
new %>% 
  group_by(id_patients) %>% 
  filter(n()==1) %>% 
  nrow() -> singlepts

#multiples
new %>% 
  group_by(id_patients) %>% 
  filter(n()>1) %>% 
  tally() %>% 
  nrow() -> multiplepts

procnum<- matrix(c("Single procedures ", singlepts, "Multiple procedures ", multiplepts), nrow = 2, byrow = T)
colnames(procnum) <- c("Group", "n")
# #Conversions
# new %>% 
#   group_by(lap, isconversion) %>% 
#   tally() -> conversions
# 
# kable(conversions[2:3,2:3], col.names = c("Conversion", "n"))

#Procedures and conversions
new %>% 
  group_by(lap, surgicalapproach) %>% 
  tally() -> proc_list

#Procedure type ---------------------

#Hepatectomies
new %>% 
  filter(grepl("hepatectomy", liverprocs)) %>% 
  mutate(side= ifelse(grepl("left", liverprocs), "left hepatectomy", "right hepatectomy")) %>%
  group_by(lap, side) %>%
  tally() -> majorhep



#Left lateral
new %>% 
  filter(grepl("left lateral", liverprocs), !grepl("hepatectomy", liverprocs)) %>% 
  group_by(lap) %>%
  tally() -> lls 
  
#Segmentectomy/biseg
new %>% 
  filter(grepl("segment", liverprocs), !grepl("hepatectomy", liverprocs), !grepl("left lateral", liverprocs)) %>% 
  group_by(lap) %>%
  tally() -> segment

#Tumorectomy (only)
new %>% 
  filter(!grepl("hepatectomy", liverprocs), !grepl("left lateral", liverprocs), 
         !grepl("segmentectomy", liverprocs)) %>% 
  group_by(lap) %>%
  tally() -> tumorectomy


```


#Demographics Output
```{r, results='asis', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
#Print demographics
kable(ptnumbers, col.names=c("Laparoscopic", "Patients", "Procedures"), align = 'l')
kable(procnum, align = 'l')
kable(proc_list[,2:3], col.names = c("Surgical approach", "n"), align = 'l')
kable(majorhep, col.names = c("Laparoscopic", "Hepatectomy", "n"), caption = "Major hepatectomy", align = 'l')
kable(lls, col.names = c("Laparoscopic", "n"), caption = "Left lateral sectionectomy", align = 'l')
kable(segment, col.names = c("Laparoscopic", "n"), caption = "Segmentectomy/Bisegmentectomy", align = 'l')
kable(tumorectomy, col.names = c("Laparoscopic", "n"), caption = "Tumorectomy", align = 'l')
```


```{r}
#Year-by-year histogram
new$year <- year(new$opdate)
new$year <- as.factor(new$year)
new %>% group_by(ismajor,lap,year) %>% tally() -> testgraph
testgraph %>% filter(as.character(year)>"1999") -> testgraph
ggplot(testgraph, aes(x=year, y=n, fill=interaction(lap,ismajor))) + geom_histogram(stat="identity") +  scale_fill_gdocs(labels=c("open minor", "lap minor", "open major", "lap major"), name="Procedure type") + theme_gdocs()

```

#Weighted stats
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
#Setup for unw vs wtd periop outcomes - Bloodloss, LOS, operative time and margin (posmarg separate)

#weighted, pooled, MI data - gets medians!
postopwtd <- MIcombine(with(design.ate, svyby(~bloodloss+hlos+optime+margin, ~lap,svyquantile, quantiles=0.5, ci=TRUE, vartype = "var")))

#unweighted, pooled MI data
postopunw <- MIcombine(with(design.unw, svyby(~bloodloss+hlos+optime+margin, ~lap,svyquantile, quantiles=0.5, ci=TRUE, vartype = "var")))

#----------------------

#Positive margin - get proportions, then compare props and extract P-value

#Weighted
posmargwtd <- MIcombine(with(design.ate, svyby(~posmarg, ~lap, svyciprop, vartype="var")))
#Rubins rule
X2wtd <- sum(mapply(function(x) x$statistic, lapply(with(design.ate, svytable(~lap + posmarg, Ntotal = 284, round = T)), prop.test)))/5

#Unweighted
posmargunw <- MIcombine(with(design.unw, svyby(~posmarg, ~lap, svyciprop, vartype="var")))
#Rubins rule
X2unw <- sum(mapply(function(x) x$statistic, lapply(with(design.unw, svytable(~lap + posmarg, Ntotal = 284, round = T)), prop.test)))/5

#GLM to give odds-ratio and p-val if required - replicant of above really
#summary(pool(with(imp.mids, glm(margin<1~lap, weights=stable.w, family = binomial))))
#summary(pool(with(imp.mids, glm(margin<1~lap, family=binomial))))

#--------------------
```

#Weighted univar output
```{r,warning=FALSE, error=FALSE, message=FALSE, echo=TRUE}
summary(postopwtd, digits = 2)
summary(postopunw, digits = 2)
summary(posmargwtd, digits =2)
pchisq(X2wtd, 1, lower.tail = F)
summary(posmargunw, digits = 2)
pchisq(X2unw, 1, lower.tail = F)

```


#KM survival and follow-up
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
#Median follow-up time by KMPF (reverse kaplan meier)
medfup <- survfit(Surv(cens_month, cens==0)~1, weights = stable.w, finaldata[finaldata$.imp==1,])

#KM survival by operative approach (in days)- any dataframe is ok
kmos <- survfit(Surv(time,ctime, cens)~lap+cluster(id_patients), weights = stable.w, finaldata[finaldata$.imp==1,])

#5yr OS by group
fiveyros <- survfit(Surv(time,ctime, cens)~lap, weights = stable.w, finaldata[finaldata$.imp==1,])

#Logrank - rho=1 gives generalised wilcoxon test, using single dataframe only - 
lros <- svylogrank(Surv(cens_month, cens)~lap, design=design.sing, rho=1)


#RFS strata by index - gaptime is what we want to know - recurrence after each operation
rfskm <- survfit(Surv(gaptime, (rec==1|cens==1))~lap + strata(index) +cluster(id_patients), weights = stable.w, finaldata[finaldata$.imp==1,])

#logrank
svylogrank(Surv(gaptime, (rec==1|cens==1))~lap+strata(index), design=design.sing, rho=1)

#compare only the first or only the second procedures - unweighted, but the numbers are the same
survdiff(Surv(gaptime, (rec==1|cens==1))~lap, finaldata[finaldata$.imp==1,], subset=index==1)
survdiff(Surv(gaptime, (rec==1|cens==1))~lap, finaldata[finaldata$.imp==1,], subset=index==2)

```

#KM output
```{r, results='asis', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
#Median FU
pander::pandoc.table(summary(medfup)$table[5:7], caption = "Median follow-up")
#OS
pander::pandoc.table(summary(kmos, scale=365.25/12)$table, caption = "Kaplan-Meier OS")
kable(data.frame("Approach"=c("Open", "Laparoscopic"), summary(fiveyros, times=1826.25)[c(1,9,11,12)]), digits = 2, caption = "5yr OS")
pander::pandoc.table(lros[[2]], caption="Generalised Wilcoxon test, OS")
#RFS
pander::pandoc.table(summary(rfskm, scale=365.25/12)$table, caption = "Kaplan-Meier RFS")
kable(data.frame("Approach"=c("Open", "Laparoscopic"), summary(rfskm, times=1826.25)[c(9,11,12)]), digits = 2, caption = "5yr RFS")

```

#Weighted regression
```{r, results='hide', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}

#OS
doublerobust.full <- with(imp.mids, coxph(Surv(time,ctime,cens)~lap+cluster(id_patients)+ismajor+isbilateral+primaryN+lesioncount, weights = stable.w))

summary(pool(doublerobust.full))

doublerobust.final <- with(imp.mids, coxph(Surv(time,ctime,cens)~lap+cluster(id_patients), weights = stable.w))

summary(pool(doublerobust.final))

#Compare HR for lap

#PDFS - PWP-CT model
rec_double.full <- with(imp.mids, coxph(Surv(time,rtime,(rec==1|cens==1))~lap+ismajor+isbilateral+primaryN+lesioncount + strata(index), weights = stable.w))

summary(pool(rec_double.full))

rec_double.final <- with(imp.mids, coxph(Surv(gaptime,(rec==1|cens==1))~lap + strata(index), weights = stable.w))

summary(pool(rec_double.final))


#OS_multivariate
doublerobust.mvr  <- with(imp.mids, coxph(Surv(time,ctime,cens)~lap+cluster(id_patients)+ismajor+isbilateral+primaryN+lesioncount+primaryT+bloodloss+mhlos+optime+posmarg, weights = stable.w))

summary(pool(doublerobust.mvr))

########Final multivariate models

os_final <- with(imp.mids, coxph(Surv(time,ctime,cens)~cluster(id_patients)+mhlos+primaryT+lap, weights = stable.w))

summary(pool(os_final))

rec_doublerobust.mvr <- with(imp.mids, coxph(Surv(gaptime,(rec==1|cens==1))~lap+cluster(id_patients)+ismajor+isbilateral+primaryN+lesioncount+primaryT+bloodloss+mhlos+optime+strata(index), weights = stable.w))

#summary(pool(rec_doublerobust.mvr))

rfs_final <- with(imp.mids, coxph(Surv(gaptime, (rec==1|cens==1))~cluster(id_patients)+mhlos+primaryT+isbilateral+lap, weights = stable.w))

#summary(pool(rfs_final))

os.final.data <- as.data.frame(summary(pool(os_final)))
os.final.data <- os.final.data %>% select(est, `Pr(>|t|)`, `lo 95`, `hi 95`)
os.final.data %>% mutate(est=exp(est), `lo 95`=exp(`lo 95`), `hi 95` = exp(`hi 95`)) -> os.final.data
row.names(os.final.data) <- c("hlos", "T2", "T3", "lap")


rfs.final.data <- as.data.frame(summary(pool(rfs_final)))
rfs.final.data <- rfs.final.data %>% select(est, `Pr(>|t|)`, `lo 95`, `hi 95`)
rfs.final.data %>% mutate(est=exp(est), `lo 95`=exp(`lo 95`), `hi 95` = exp(`hi 95`)) -> rfs.final.data
row.names(rfs.final.data) <- c("hlos", "T2", "T3", "isbilateral", "lap")

```

#Regression output
```{r, results='asis', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
kable(os.final.data, align = 'l')
kable(rfs.final.data, align = 'l')
source("new_os_surv_curv.R")
source("new_rfs_surv_curv.R")
os_curve
rfs_curve
```
