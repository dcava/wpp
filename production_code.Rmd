---
title: "IPTW"
author: "David Cavallucci"
date: "7 May 2015"
output: html_document
---

#Load libraries
```{r,results='hide', warning=FALSE, error=FALSE, message=FALSE}
library(gdata)
library(readxl)
library(readr)
library(ggplot2)
library(survival)
library(lubridate)
library(mice)
source("~/Dropbox/Research/colorectal mets/scripts/stable.weights.R")
library(twang)
library(dplyr)
library(tidyr)
library(magrittr)
library(knitr)
library(stringr)
```

#Import, clean-up
```{r}
source("data_tidying.R")
rm(raw, dif_segs, id_twostage)
```

#Demographics
```{r}
#Summarise distinct patient numbers and total procedure numbers by surgical approach
new %>% 
  group_by(lap) %>% 
  summarise(patients=n_distinct(id_patients), procedures=n()) %>% 
  kable(col.names=c("Laparoscopic", "Patients", "Procedures"))

#Single ops
new %>% 
  group_by(id_patients) %>% 
  filter(n()==1) %>% 
  nrow() -> singlepts

#multiples
new %>% 
  group_by(id_patients) %>% 
  filter(n()>1) %>% 
  tally() %>% 
  nrow() -> multiplepts

str_c("Number of patients with single procedures: ", singlepts)
str_c("Number of patients with multiple procedures: ", multiplepts)

#Conversions
new %>% 
  group_by(lap, isconversion) %>% 
  tally() -> conversions

kable(conversions[2:3,2:3], col.names = c("Conversion", "n"))

#Procedures
new %>% 
  group_by(lap, surgicalapproach) %>% 
  tally() -> proc_list

kable(proc_list[,2:3], col.names = c("Surgical approach", "n"))

#Procedure type ---------------------

#Hepatectomies
new %>% 
  filter(grepl("hepatectomy", liverprocs)) %>% 
  mutate(side= ifelse(grepl("left", liverprocs), "left hepatectomy", "right hepatectomy")) %>%
  group_by(lap, side) %>%
  tally()

#Left lateral
new %>% 
  filter(grepl("left lateral", liverprocs), !grepl("hepatectomy", liverprocs)) %>% 
  group_by(lap) %>%
  tally()

#Tumorectomy (only)
new %>% 
  filter(!grepl("hepatectomy", liverprocs), !grepl("left lateral", liverprocs), 
         !grepl("segmentectomy", liverprocs)) %>% 
  group_by(lap) %>%
  tally()

#Year-by-year histogram
new$year <- year(new$opdate)
new$year <- as.factor(new$year)
new %>% group_by(ismajor,lap,year) %>% tally() -> testgraph
ggplot(testgraph[-17,], aes(x=year, y=n, fill=interaction(lap,ismajor))) + geom_histogram(stat="identity")

```